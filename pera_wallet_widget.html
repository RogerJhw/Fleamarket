<!DOCTYPE html>
<html>
<head>
  <title>Pera Wallet Connect Widget</title>
  <script src="https://cdn.jsdelivr.net/npm/@perawallet/connect@latest/dist/perawallet-connect.min.js"></script>
</head>
<body>
  <button id="connect-button">Connect Wallet</button>
  <p id="wallet-address"></p>

  <script>
    const button = document.getElementById("connect-button");
    const output = document.getElementById("wallet-address");

    async function connectWallet() {
      console.log("window keys:", Object.keys(window));
      console.log("PeraWalletConnect type:", typeof window.PeraWalletConnect);
      let ctor = null;
      if (typeof window.PeraWalletConnect === 'function') {
        ctor = window.PeraWalletConnect;
      } else if (window.PeraWalletConnect && typeof window.PeraWalletConnect.default === 'function') {
        ctor = window.PeraWalletConnect.default;
      } else if (window.PeraWalletConnect && typeof window.PeraWalletConnect.Connect === 'function') {
        ctor = window.PeraWalletConnect.Connect;
      }
      if (!ctor) {
        output.textContent = 'Unable to load PeraWalletConnect.';
        return;
      }
      try {
        const peraWallet = new ctor();
        const accounts = await peraWallet.connect();
        const address = accounts[0];
        output.textContent = `Connected address: ${address}`;
        window.parent.postMessage({ type: 'wallet_connected', address: address }, '*');
      } catch (err) {
        output.textContent = `Connection failed: ${err.message}`;
        window.parent.postMessage({ isStreamlitMessage: true, type: 'walletError', error: err.message }, '*');
      }
    }

    button.addEventListener("click", connectWallet);
  </script>
</body>
</html>
